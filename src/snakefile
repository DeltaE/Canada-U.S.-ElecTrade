#####################################
## REQUIRED FILES 
#####################################

osemosysFiles = [
	'AccumulatedAnnualDemand.csv',
	'AnnualEmissionLimit.csv',
	'AnnualExogenousEmission.csv',
	'AvailabilityFactor.csv',
	'CapacityFactor.csv',
	'CapacityOfOneTechnologyUnit.csv',
	'CapacityToActivityUnit.csv',
	'CapitalCost.csv',
	'CapitalCostStorage.csv',
	'Conversionld.csv',
	'Conversionlh.csv',
	'Conversionls.csv',
	'DAILYTIMEBRACKET.csv',
	'DaysInDayType.csv',
	'DaySplit.csv',
	'DAYTYPE.csv',
	'default_values.csv',
	'DepreciationMethod.csv',
	'DiscountRate.csv',
	'DiscountRateStorage.csv',
	'EMISSION.csv',
	'EmissionActivityRatio.csv',
	'EmissionsPenalty.csv',
	'FixedCost.csv',
	'FUEL.csv',
	'InputActivityRatio.csv',
	'MinStorageCharge.csv',
	'MODE_OF_OPERATION.csv',
	'ModelPeriodEmissionLimit.csv',
	'ModelPeriodExogenousEmission.csv',
	'OutputActivityRatio.csv',
	'OperationalLife.csv',
	'REMinProductionTarget.csv',
	'REGION.csv',
	'ReserveMargin.csv',
	'ReserveMarginTagFuel.csv',
	'ReserveMarginTagTechnology.csv',
	'ResidualCapacity.csv',
	'ResidualStorageCapacity.csv',
	'RETagFuel.csv',
	'RETagTechnology.csv',
	'SEASON.csv',
	'SpecifiedAnnualDemand.csv',
	'SpecifiedDemandProfile.csv',
	'STORAGE.csv',
	'StorageLevelStart.csv',
	'StorageMaxChargeRate.csv',
	'StorageMaxDischargeRate.csv',
	'TECHNOLOGY.csv',
	'TechnologyFromStorage.csv',
	'TechnologyToStorage.csv',
	'TIMESLICE.csv',
	'TotalAnnualMaxCapacity.csv',
	'TotalAnnualMaxCapacityInvestment.csv',
	'TotalAnnualMinCapacity.csv',
	'TotalAnnualMinCapacityInvestment.csv',
	'TotalTechnologyAnnualActivityLowerLimit.csv',
	'TotalTechnologyAnnualActivityUpperLimit.csv',
	'TotalTechnologyModelPeriodActivityLowerLimit.csv',
	'TotalTechnologyModelPeriodActivityUpperLimit.csv',
	'TradeRoute.csv',
	'VariableCost.csv',
	'YEAR.csv',
	'YearSplit.csv'
]

usaFiles = [
	'AvailabilityFactor.csv',
	'CapacityFactor.csv',
	'CapacityToActivityUnit.csv',
	'CapitalCost.csv',
	'EmissionActivityRatio.csv',
	'FixedCost.csv',
	'FUEL.csv',
	'InputActivityRatio.csv',
	'OutputActivityRatio.csv',
	'OperationalLife.csv',
	'ReserveMargin.csv',
	'ReserveMarginTagFuel.csv',
	'ReserveMarginTagTechnology.csv',
	'ResidualCapacity.csv',
	'SpecifiedAnnualDemand.csv',
	'SpecifiedDemandProfile.csv',
	'TECHNOLOGY.csv',
	'TotalAnnualMaxCapacity.csv',
	'VariableCost.csv',
]

provinces = ['BC','AB','SAS','MAN','ONT','QC','NB','NL','NS','PEI']

#####################################
## TARGETS
#####################################

fileName = 'CanadaUSA'
inputDir = '../dataSources/'
scriptsDir = '../scripts/'
outputDir = '../src/'

rule all:
	input: 
		outputDir + fileName + '.txt'

rule dataFile:
	input:
		outputDir + fileName + '.txt'

rule lpFile:
	input: 
		outputDir + fileName + '.lp'

#####################################
## INTERMEDIATE RULES
#####################################

rule ConfigFile:
	input:
		inputDir + 'Regionalization.xlsx',
		inputDir + 'Trade.csv'
	output:
		inputDir + 'techList_AUTO_GENERATED.csv',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		outputDir + 'data/Canada/EMISSION.csv',
		outputDir + 'data/Canada/STORAGE.csv',
		outputDir + 'data/Canada/TECHNOLOGY.csv',
		outputDir + 'data/Canada/FUEL.csv'
	shell:
		'python ' + scriptsDir + 'config.py'

rule AvailabilityFactor:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv'
	output:
		outputDir + 'data/Canada/AvailabilityFactor.csv'
	shell:
		'python ' + scriptsDir + 'AvailabilityFactor.py'

rule CapacityFactor:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'NREL_Costs.csv',
		expand(inputDir + 'CapacityFactor/SPV_{province}.csv', province = provinces),
		expand(inputDir + 'CapacityFactor/WND_{province}.csv', province = provinces)
	output:
		outputDir + 'data/Canada/CapacityFactor.csv'
	shell:
		'python ' + scriptsDir + 'CapacityFactor.py'

rule CapacityToActivity:
	input:
		outputDir + 'data/Canada/REGION.csv',
		outputDir + 'data/Canada/TECHNOLOGY.csv'
	output:
		outputDir + 'data/Canada/CapacityToActivityUnit.csv'
	shell:
		'python ' + scriptsDir + 'CapacityToActivity.py'

rule Costs:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'NREL_Costs.csv',
		inputDir + 'P2G_FC_Costs.xlsx',
		inputDir + 'Trade.csv'
	output:
		outputDir + 'data/Canada/CapitalCost.csv',
		outputDir + 'data/Canada/FixedCost.csv',
		outputDir + 'data/Canada/VariableCost.csv'
	shell:
		'python ' + scriptsDir + 'Costs.py'

rule EmissionActivityRatio:
	input:
		inputDir + 'EmissionActivityRatioByTechnology.csv',
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv'
	output:
		outputDir + 'data/Canada/EmissionActivityRatio.csv'
	shell:
		'python ' + scriptsDir + 'EmissionActivityRatio.py'

rule ActivityRatio:
	input:
		inputDir + 'InputActivityRatioByTechnology.csv', 
		inputDir + 'OutputActivityRatioByTechnology.csv',
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'techList_AUTO_GENERATED.csv',
		inputDir + 'Trade.csv'
	output:
		outputDir + 'data/Canada/InputActivityRatio.csv',
		outputDir + 'data/Canada/OutputActivityRatio.csv'
	shell:
		'python ' + scriptsDir + 'InOutActivityRatio.py'

rule ReserveMargin:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'ProvincialAnnualDemand.csv',
		inputDir + 'ProvincialHourlyLoads_TimeAdjusted_AUTO_GENERATED.csv'
	output:
		outputDir + 'data/Canada/ReserveMargin.csv',
		outputDir + 'data/Canada/ReserveMarginTagTechnology.csv',
		outputDir + 'data/Canada/ReserveMarginTagFuel.csv'
	shell:
		'python ' + scriptsDir + 'ReserveMargin.py'

rule ResidualCapacity:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'OperationalLifeTechnology.csv',
		inputDir + 'ResidualCapacitiesByProvince.csv',
		inputDir + 'Trade.csv'
	output:
		outputDir + 'data/Canada/ResidualCapacity.csv',
		outputDir + 'data/Canada/OperationalLife.csv'
	shell:
		'python ' + scriptsDir + 'ResidualCapacity.py'

rule AnnualDemand:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'ProvincialAnnualDemand.csv'
	output:
		outputDir + 'data/Canada/SpecifiedAnnualDemand.csv'
	shell:
		'python ' + scriptsDir + 'SpecifiedAnnualDemand.py'

rule DemandProfile:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'ProvincialHourlyLoads.xlsx'
	output:
		outputDir + 'data/Canada/SpecifiedDemandProfile.csv',
		inputDir + 'ProvincialHourlyLoads_TimeAdjusted_AUTO_GENERATED.csv'
	shell:
		'python ' + scriptsDir + 'SpecifiedDemandProfile.py'

rule StorageCost:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'techList_AUTO_GENERATED.csv'
	output:
		outputDir + 'data/Canada/CapitalCostStorage.csv'
	shell:
		'python ' + scriptsDir + 'StorageCosts.py'

rule StorageLife:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'techList_AUTO_GENERATED.csv'
	output:
		outputDir + 'data/Canada/OperationalLifeStorage.csv'
	shell:
		'python ' + scriptsDir + 'StorageLife.py'

rule EmissionPenalty:
	input:
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'EmissionPenaltyByYear.csv'
	output:
		outputDir + 'data/Canada/EmissionsPenalty.csv'
	shell:
		'python ' + scriptsDir + 'EmissionPenalty.py'

rule RETags:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
	output:
		outputDir + 'data/Canada/RETagTechnology.csv'
	shell:
		'python ' + scriptsDir + 'RETags.py'

rule TechToFromStorage:
	input:
		inputDir + 'Regionalization.xlsx',
		outputDir + 'data/Canada/YEAR.csv',
		outputDir + 'data/Canada/REGION.csv',
		inputDir + 'techList_AUTO_GENERATED.csv'
	output:
		outputDir + 'data/Canada/TechnologyToStorage.csv',
		outputDir + 'data/Canada/TechnologyFromStorage.csv'
	shell:
		'python ' + scriptsDir + 'TechToFromStorage.py'

rule UsaData:
	input:
		inputDir + 'Regionalization.xlsx',
		inputDir + 'USA_Data.xlsx',
		inputDir + 'USA_Trade.csv'
	output:
		expand(outputDir + 'data/USA/{usaFile}', usaFile = usaFiles)
	shell:
		'python ' + scriptsDir + 'usaData.py'

rule mergeData:
	input:
		expand(outputDir + 'data/Canada/{osemosysFile}', osemosysFile = osemosysFiles),
		expand(outputDir + 'data/USA/{usaFile}', usaFile = usaFiles)
	output:
		expand(outputDir + 'data/{osemosysFile}', osemosysFile = osemosysFiles)
	shell:
		'python ' + scriptsDir + 'MergeCanUsaData.py'

rule otooleConvert:
	input:
		datapackage = outputDir + 'datapackage.json',
		csvFiles = expand(outputDir + 'data/{osemosysFile}', osemosysFile = osemosysFiles)
	output:
		outputDir + fileName + '.txt'
	shell:
		'otoole convert datapackage datafile {input.datapackage} {output}'

rule createLP:
	input:
		modelFile = outputDir + 'Osemosys_TacoMod.txt',
		dataFile = outputDir + fileName + '.txt'
	output:
		outputDir + fileName + '.lp'
	shell:
		'glpsol -m {input.modelFile} -d {input.dataFile} --wlp {output} --check'


#####################################
## CLEANING RULES
#####################################

